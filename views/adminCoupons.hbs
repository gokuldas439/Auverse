
<style>
    .error{
        color:red;
    }
</style>

<div class="container" style="margin-top: 12rem;">
    <p style="color: red;">{{this.categoryError}}</p>
    <div class="table-responsive">
        <div class="table-wrapper">
            <div class="table-title">
                <div class="row">
                    <div class="col-xs-5">
                        <h2><b>Coupon Management</b></h2>
                    </div>
                    <div class="col-xs-7">
                        {{!-- <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                            data-bs-target="#exampleModal{{@index}}" style="padding:0px; "><a href="/adduser"
                                class="btn btn-primary"><i class="fa-solid fa-pen"></i> <span>Add
                                    Category</span></a> --}}

                            <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                                data-bs-target="#exampleModal"><i class="fa-solid fa-pen"></i>Add Coupon</button>

                            <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel"
                                aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="exampleModalLabel">Add Coupon</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                aria-label="Close"></button>
                                        </div>
                                        <form id="sform" >
                                            <div class="modal-body">

                                                <div class="mb-3">
                                                    <span id="errormsg" style="color: red;"></span><br>

                                                    <label for="recipient-coupon" class="col-form-label">Coupon code
                                                        :</label>
                                                    <input type="text" class="form-control" id="recipient-coupon"
                                                        name="coupon">
                                                </div>
                                                <div class="mb-3">
                                                    <span id="discounterr" style="color: red;"></span><br>
                                                    <label for="recipient-discount" class="col-form-label">Discount %
                                                        :</label>
                                                    <input type="number" class="form-control" id="recipient-discount"
                                                        name="discount">
                                                </div>
                                                <div class="mb-3">
                                                    <span id="dateerr" style="color: red;"></span><br>
                                                    <label for="recipient-expiresOn" class="col-form-label">Coupon
                                                        Expiry date :</label>
                                                    <input type="date" class="form-control" id="recipient-expiresOn"
                                                        name="expiresOn">
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary"
                                                    data-bs-dismiss="modal">Close</button>
                                                <button type="submit" class="btn"
                                                    style="backgorund-color: green !important;">Add Coupon</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>


                    </div>
                </div>
            </div>
            <table class="table table-striped table-hover mydatatable" id="">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Coupon</th>
                        <th>Discount</th>
                        <th>Created On</th>
                        <th>Expires On</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {{#each couponList}}

                    <tr>


                        <td class="indexNo">{{inc @index}}</td>


                        <td>{{this.coupon}}</td>
                        <td>{{this.discount}}%</td>
                        <td>{{this.createdOn}}</td>
                        <td>{{this.expiresOn}}</td>

                        {{!-- <td><span class="status text-success">&bull;</span> Active</td> --}}
                        <td>
                            <!-- Button trigger modal -->
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                                data-bs-target="#exampleModal{{@index}}" style="padding:0px; ">
                                <i class="material-icons" style="margin-top: 5px;">edit</i>
                            </button>

                            <!-- Modal -->

                            <div class="modal fade" id="exampleModal{{@index}}" tabindex="-1"
                                aria-labelledby="exampleModalLabel" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="exampleModalLabel{{@index}}">Update Coupon
                                            </h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                aria-label="Close"></button>
                                        </div>
                                       <form id="editform" action="/editCoupon/{{this._id}}" method="post">
                                            <div class="modal-body">

                                                <div class="mb-3">
                                                    <span id="errormsgEdit" style="color: red;"></span><br>

                                                    <label for="couponname" class="col-form-label">Coupon code
                                                        :</label>
                                                    <input type="text" class="form-control" id="couponname"
                                                        name="coupon" value="{{this.coupon}}" disabled>
                                                </div>
                                                <div class="mb-3">
                                                    <span id="discounterrEdit" style="color: red;"></span><br>
                                                    <label for="coupondiscount" class="col-form-label">Discount %
                                                        :</label>
                                                    <input type="number" class="form-control" id="coupondiscount"
                                                        name="discount" value="{{this.discount}}">
                                                </div>
                                                <div class="mb-3">
                                                    <span id="dateerrEdit" style="color: red;"></span><br>
                                                    <label for="datefield" class="col-form-label">Coupon
                                                        Expiry date :( Expiring date {{this.expiresOn}})</label>
                                                    <input type="date" class="form-control" id="datefield"
                                                        name="expiresOn" value="{{this.modifiedOn}}">
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary"
                                                    data-bs-dismiss="modal">Close</button>
                                                <button type="submit" class="btn"
                                                    style="backgorund-color: green !important;">Edit Coupon</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
        </div>




        <!-- Button trigger modal -->
        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#exampleModal1{{@index}}"
            style="padding:0px; ">
            <i class="material-icons" style="margin-top: 5px;">&#xE5C9;</i>
        </button>

        <!-- Modal -->
        <div class="modal fade" id="exampleModal1{{@index}}" tabindex="-1" aria-labelledby="exampleModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel1{{@index}}">Delete Coupon</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        This Action Will Delete this Coupon.<br>
                        Are You Sure You Want to Delete ?
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <a href="/deleteCoupon/{{this._id}}"><button type="button" class="btn btn-danger">Delete
                                Coupon</button></a>
                    </div>
                </div>
            </div>
        </div>
        </td>

        </tr>
        {{/each}}


        </tbody>
        </table>
    </div>
 
<script>
 const date=new Date();
      var month = date.getUTCMonth() + 1; //months from 1-12
      var day = date.getUTCDate();
      var year = date.getUTCFullYear();
      var newdate = year + "/" + month + "/" + day;
      document.getElementById('datefield').setAttribute('max',newdate)
</script>


<script>
    $(document).ready(function () {
        $("#sform").validate({
            rules: {
                coupon: {
                    required: true,
                },
                discount: {
                    required: true,                    
                },
                expiresOn: {
                    required: true,
                },
            },
            messages: {
                coupon: {
                    required: "Please enter Coupon name *",
                },
                discount: {
                    required: "Please enter the discount percentage *",

                },
                expiresOn: {
                    required: "Please select the expiry date *",

                },

            },
        
 submitHandler: function (form,e) { 
    e.preventDefault();
    $.ajax({
      url: "/addCoupon",
      method: 'post',
      data: $('#sform').serialize(),


      success: (response) => {
        console.log(response)
        if (response.status =='discounterr') {
          document.getElementById('discounterr').innerHTML ="The discount % must be between 0 - 99"
        }
       else if (response.status=="dateerr") {
          document.getElementById('dateerr').innerHTML ="Expiry Date must be greater than today's Date"
        
        }
       else if (response.status=="couponExists") {
          document.getElementById('errormsg').innerHTML ="The coupon you have entered already exists"
        
        }
       else if (response.status=="success") {
          location.reload();
        
        }


      }
    })
  
 }
  });
});
</script>





<script>
    $(document).ready(function () {
        $("#editform").validate({
            rules: {
                coupon: {
                    required: true,
                },
                discount: {
                    required: true,
                    min:1,
                    max:99                    
                },
                expiresOn: {
                    required: true,
                },
            },
            messages: {
                coupon: {
                    required: "Please enter Coupon name *",
                },
                discount: {
                    required: "Please enter the discount percentage *",

                },
                expiresOn: {
                    required: "Please select the expiry date *",

                },

            },
  });
});
</script>